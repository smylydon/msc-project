"use strict";function drawSpreadSheet(e,t){e=e||1,t=t||1;for(var n=document.querySelector("table"),o=0;o<t;o++)for(var r=n.insertRow(-1),l=0;l<e;l++){var a=String.fromCharCode("A".charCodeAt(0)+l-1);r.insertCell(-1).innerHTML=o&&l?"<input id='"+a+o+"'/>":o||a}}function processElements(e,t){INPUTS.each(function(t,n){function o(e,t,n){e.value=n,t.val(e.value),localStorage[e.id]=e.formula,e.pusher()}function r(e,t){return e+t}function l(e,t){return e-t}function a(e,t){return e*t}function c(e,t){return 0===t?0:e/t}function i(e,t){var n="",o=s(e.left);return n=e.right?s(e.right):Bacon.constant(0),o.combine(n,t)}function s(e){var t=0,n=0,o=0,u=0;if(console.log("calculate:",e.type),"number"===e.type)o=Bacon.constant(parseFloat(e.token));else if("cellname"===e.type)u=spreadSheet.getCellById(e.token),o=u.bus,u.pusher(),console.log("got cell:",o);else if("unary"===e.type)n=s(e.right),"+"===e.token?o=n:(t=Bacon.constant(0),o=t.combine(n,l));else if("leftparen"===e.type)t=s(e.left),n=e.right,"rightparen"===n.type&&(o=t);else if("operator"===e.type)switch(e.token){case"+":o=i(e,r);break;case"-":o=i(e,l);break;case"*":o=i(e,a);break;case"/":o=i(e,c)}return o}var u=$(n),f={element:u,id:u.attr("id")};cells.push(f),e.filter(function(e){return e.element===f.id}).onValue(function(e){var t=spreadSheet.getCellById(e.element),n=e.formula.toUpperCase();if(t.formula=n,"="===n.charAt(0)){n=window.parser(n.substring(1));var r=s(n);console.log("do onValue"),r.onValue(function(e){console.log("do updateCell:",t.id,e),o(t,u,e)})}else n=isNaN(parseFloat(n))?n:parseFloat(n),o(t,u,n)}),u.asEventStream("focus").onValue(function(e){var t=e.target.id,n=localStorage[t]||"";u.val(n)}),u.asEventStream("blur").map(function(e){var t=e.target.id,n=e.target.value;return localStorage[t]=n,{element:t,formula:n,user_id:userId}}).onValue(function(e){socket.emit("write",e)})}),spreadSheet.addCells(cells)}var _=_,Bacon=Bacon,CellFactory=function(){function e(e){this.id=e.id,this.element=e.element,this.value=0,this.bus=new Bacon.Bus}return e.prototype.pusher=function(){console.log("pushing:",this.id,this.value),this.bus.push(this.value)},{getNewCell:function(t){return new e(t)}}}(),SpreadSheetFactory=function(){function e(e){this.cells=[],this.addCells(e)}return e.prototype.getCellById=function(e){return _.find(this.cells,{id:e})},e.prototype.addCells=function(e){e=_.isArray(e)?e:[],e=e.map(function(e){return CellFactory.getNewCell(e)}),Array.prototype.push.apply(this.cells,e)},e.prototype.addCell=function(e){this.cells.push(CellFactory.getNewCell(e))},e.prototype.removeCellsById=function(e){e=_.isArray(e)?e:[],_.forEach(e,function(e){_.remove(this.cells,function(t){return t.id===e})})},e.prototype.removeCellById=function(e){_.remove(this.cells,function(t){return t.id===e})},{getSpreadSheet:function(t){return new e(t)}}}(),spreadSheet=SpreadSheetFactory.getSpreadSheet();drawSpreadSheet(10,10);var INPUTS=$("input"),cells=[],userId,socket=io.connect("http://localhost:5000");socket.on("connect",function(e){console.log("connect"),socket.emit("join","Hello World from client"),socket.on("userid",function(e){userId=e});var t=Bacon.fromBinder(function(e){socket.on("update",function(t){e(t)})}),n=Bacon.fromBinder(function(e){socket.on("messages",function(t){e(t)})});processElements(t,n)});
//# sourceMappingURL=spreadsheet.js.map
