{"version":3,"sources":["spreadsheet.js"],"names":["processElements","socketUpdate","socketMessage","INPUTS","each","index","elem","updateCell","cell","velement","value","formula","element","val","localStorage","id","bus","push","add","a","b","minus","multiply","divide","makeProperty","num","min","Bacon","fromBinder","sink","toProperty","fetchAndCombine","token","combiner","right","left","calculate","combine","type","parseFloat","spreadSheet","getCellById","$","model","attr","cells","filter","data","onValue","charAt","window","parser","substring","total","x","isNaN","asEventStream","event","elementid","target","map","console","log","user_id","userId","socket","emit","addCells","_","Cell","this","Bus","SpreadSheetFactory","SpreadSheet","prototype","find","isArray","Array","apply","addCell","removeCellsById","ids","forEach","remove","removeCellById","getSpreadSheet","i","row","document","querySelector","insertRow","j","letter","String","fromCharCode","charCodeAt","insertCell","innerHTML","io","connect","on"],"mappings":"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","file":"spreadsheet.js","sourcesContent":["/* eslint-disable */\nvar _ = _;\nvar Bacon = Bacon;\n/* eslint-enable */\n\nvar Cell = function (cell) {\n  this.id = cell.id;\n  this.element = cell.element;\n  this.bus = new Bacon.Bus();\n};\n\nvar SpreadSheetFactory = (function () {\n  function SpreadSheet(cells) {\n    this.bus = new Bacon.Bus();\n    this.cells = [];\n    this.addCells(cells);\n  }\n\n  SpreadSheet.prototype.getCellById = function (id) {\n      return _.find(this.cells, { id: id});\n  };\n\n  SpreadSheet.prototype.addCells = function (cells) {\n    cells = _.isArray(cells) ? cells : [];\n    cells = cells.map(function (cell) {\n      return new Cell(cell);\n    });\n    Array.prototype.push.apply(this.cells, cells);\n  };\n\n  SpreadSheet.prototype.addCell = function (cell) {\n    this.cells.push(new Cell(cell));\n  };\n\n  SpreadSheet.prototype.removeCellsById = function (ids) {\n    ids = _.isArray(ids) ? ids : [];\n    _.forEach(ids, function (id) {\n      _.remove(this.cells, function (cell) {\n        return cell.id === id;\n      });\n    });\n  };\n\n  SpreadSheet.prototype.removeCellById = function (id) {\n    _.remove(this.cells, function (cell) {\n      return cell.id === id;\n    });\n  };\n\n  return {\n    getSpreadSheet: function (cells) {\n      return new SpreadSheet(cells);\n    }\n  };\n\n})();\n\nvar spreadSheet = SpreadSheetFactory.getSpreadSheet();\n\nfor (var i = 0; i < 6; i++) {\n  var row = document.querySelector(\"table\")\n    .insertRow(-1);\n  for (var j = 0; j < 6; j++) {\n    var letter = String.fromCharCode(\"A\".charCodeAt(0) + j - 1);\n    row.insertCell(-1)\n      .innerHTML = i && j ? \"<input id='\" + letter + i + \"'/>\" :\n      i || letter;\n  }\n}\n\n//var DATA = {};\n\nvar INPUTS = $('input'); //get all inputs\nvar cells = [];\n\nfunction processElements(socketUpdate, socketMessage) {\n  INPUTS.each(function (index, elem) {\n    var element = $(elem);\n    var model = {\n      element: element,\n      id: element.attr('id')\n    };\n\n    cells.push(model);\n\n    function updateCell(cell,velement, value) {\n      cell.value = value;\n      cell.formula = value;\n      element.val(cell.value);\n      localStorage[cell.id] = cell.formula;\n      cell.bus.push({ value: cell.value});\n    }\n\n    socketUpdate.filter(function (data) {\n      return data.element === model.id;\n    }).onValue(function (data) {\n      var cell = spreadSheet.getCellById(data.element);\n      var value = data.formula;\n\n      if (value.charAt(0) === \"=\") {\n        cell.formula = value;\n        value = window.parser(value.substring(1));\n        var total = calculate(value);\n\n        total.onValue(function (x) {\n          updateCell(cell, element, x);\n        });\n\n        //DATA\n        //return total;\n      } else {\n        value = isNaN(parseFloat(value)) ? value : parseFloat(value);\n        updateCell(cell, element, value);\n      }\n\n    });\n\n    element.asEventStream('focus')\n      .onValue(function (event) {\n        var elementid = event.target.id;\n        var value = localStorage[elementid] || \"\";\n        element.val(value);\n      });\n\n    element.asEventStream('blur')\n      .map(function (event) {\n        var elementid = event.target.id;\n        var formula = event.target.value;\n        localStorage[elementid] = formula;\n        console.log('blurStream');\n        return {\n          element: elementid,\n          formula: formula,\n          user_id: userId\n        };\n      }).onValue(function (data) {\n        socket.emit('write', data);\n      });\n\n    function add(a,b) {\n      return a+b;\n    }\n\n    function minus(a,b) {\n      return a-b;\n    }\n\n    function multiply(a,b) {\n      return a*b;\n    }\n\n    function divide(a,b) {\n      if (b === 0) {\n        return 0;\n      }\n      return a/b;\n    }\n\n    function makeProperty(num, min) {\n      min = min || 0;\n      return Bacon.fromBinder(function (sink) {\n        sink(num);\n      }).toProperty(min);\n    }\n\n    function fetchAndCombine(token, combiner) {\n      var right = '';\n      var left = calculate(token.left);\n      if (token.right) {\n        right = calculate(token.right);\n      } else {\n        right = makeProperty(0);\n      }\n      return left.combine(right, combiner);\n    }\n\n    function calculate(token) {\n      var left = 0;\n      var right = 0;\n      var value = 0;\n\n      if (token.type === 'number') {\n        value = makeProperty(parseFloat(token.token));\n      } else if (token.type === 'cellname') {\n        value = spreadSheet.getCellById(token.token);\n      } else if (token.type === 'unary') {\n        right = calculate(token.right);\n        if (token.token === '+') {\n          value  = right;\n        } else {\n          left = makeProperty(0);\n          value = left.combine(right, minus);\n        }\n      } else if (token.type === \"leftparen\") {\n        left = calculate(token.left);\n        right = token.right;\n        if (right.type === 'rightparen') {\n          value = left;\n        }\n      } else if (token.type === 'operator') {\n\n        switch (token.token) {\n          case '+':\n              value = fetchAndCombine(token, add);\n            break;\n          case '-':\n              value = fetchAndCombine(token, minus);\n            break;\n          case '*':\n              value = fetchAndCombine(token, multiply);\n            break;\n          case '/':\n              value = fetchAndCombine(token, divide);\n            break;\n        }\n      }\n      return value;\n    }\n    /* eslint-disable */\n    function getter() {\n      var value = localStorage[element.attr('id')] || \"\";\n      var total = 0;\n      if (value.charAt(0) === \"=\") {\n        value = window.parser(value.substring(1));\n        total = calculate(value);\n        //DATA\n        return total;\n      } else {\n        return isNaN(parseFloat(value)) ? value : parseFloat(value);\n      }\n    }\n    /* eslint-enable */\n\n  });\n\n  spreadSheet.addCells(cells);\n}\n\nvar userId;\n/* eslint-disable */\nvar socket = io.connect('http://localhost:5000');\n/* eslint-enable */\n\nsocket.on('connect', function (data) {\n  console.log('connect');\n  socket.emit('join', 'Hello World from client');\n\n  socket.on('userid', function (data) {\n    userId = data;\n  });\n\n  var socketUpdate = Bacon.fromBinder(function (sink) {\n    socket.on('update', function (data) {\n      sink(data);\n    });\n  });\n\n  var socketMessage = Bacon.fromBinder(function (sink) {\n    socket.on('messages', function (data) {\n      sink(data);\n    });\n  });\n\n  processElements(socketUpdate, socketMessage);\n});\n"],"sourceRoot":"/source/"}