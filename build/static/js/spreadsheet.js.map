{"version":3,"sources":["spreadsheet.js"],"names":["drawSpreadSheet","width","height","table","document","querySelector","i","row","insertRow","j","letter","String","fromCharCode","charCodeAt","insertCell","innerHTML","processElements","socketUpdate","socketMessage","INPUTS","each","index","elem","updateCell","cell","element","value","val","localStorage","id","formula","pusher","add","a","b","minus","multiply","divide","fetchAndCombine","token","combiner","right","left","calculate","Bacon","constant","combine","console","log","type","parseFloat","spreadSheet","getCellById","bus","pushers","push","$","model","attr","cells","filter","data","onValue","toUpperCase","_","isUndefined","charAt","substring","window","parser","x","forEach","asEventStream","event","elementid","target","map","user_id","userId","socket","emit","addCells","CellFactory","Cell","this","Bus","prototype","getNewCell","SpreadSheetFactory","SpreadSheet","find","isArray","Array","apply","addCell","removeCellsById","ids","remove","removeCellById","getSpreadSheet","io","connect","on","fromBinder","sink"],"mappings":"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","file":"spreadsheet.js","sourcesContent":["/* eslint-disable */\nvar _ = _;\nvar Bacon = Bacon;\n/* eslint-enable */\n\nvar CellFactory = (function () {\n  function Cell(data) {\n    this.id = data.id;\n    this.element = data.element;\n    this.value = 0;\n    this.bus = new Bacon.Bus();\n  }\n\n  Cell.prototype.pusher = function () {\n    this.bus.push(this.value);\n  };\n  return {\n    getNewCell: function (data) {\n      return new Cell(data);\n    }\n  };\n})();\n\nvar SpreadSheetFactory = (function () {\n  function SpreadSheet(cells) {\n    this.cells = [];\n    this.addCells(cells);\n  }\n\n  SpreadSheet.prototype.getCellById = function (id) {\n    return _.find(this.cells, {\n      id: id\n    });\n  };\n\n  SpreadSheet.prototype.addCells = function (cells) {\n    cells = _.isArray(cells) ? cells : [];\n    cells = cells.map(function (data) {\n      return CellFactory.getNewCell(data);\n    });\n    Array.prototype.push.apply(this.cells, cells);\n  };\n\n  SpreadSheet.prototype.addCell = function (data) {\n    this.cells.push(CellFactory.getNewCell(data));\n  };\n\n  SpreadSheet.prototype.removeCellsById = function (ids) {\n    ids = _.isArray(ids) ? ids : [];\n    _.forEach(ids, function (id) {\n      _.remove(this.cells, function (cell) {\n        return cell.id === id;\n      });\n    });\n  };\n\n  SpreadSheet.prototype.removeCellById = function (id) {\n    _.remove(this.cells, function (cell) {\n      return cell.id === id;\n    });\n  };\n\n  return {\n    getSpreadSheet: function (cells) {\n      return new SpreadSheet(cells);\n    }\n  };\n\n})();\n\nvar spreadSheet = SpreadSheetFactory.getSpreadSheet();\n\nfunction drawSpreadSheet(width, height) {\n  width = width || 1;\n  height = height || 1;\n\n  var table = document.querySelector(\"table\");\n\n  for (var i = 0; i < height; i++) {\n    var row = table.insertRow(-1);\n    for (var j = 0; j < width; j++) {\n      var letter = String.fromCharCode(\"A\".charCodeAt(0) + j - 1);\n      row.insertCell(-1)\n        .innerHTML = i && j ? \"<input id='\" + letter + i + \"'/>\" :\n        i || letter;\n    }\n  }\n}\n\ndrawSpreadSheet(10, 10);\n\nvar INPUTS = $('input'); //get all inputs\nvar cells = [];\n\nfunction processElements(socketUpdate, socketMessage) {\n  INPUTS.each(function (index, elem) {\n    var element = $(elem);\n    var model = {\n      element: element,\n      id: element.attr('id')\n    };\n    var pushers = [];\n\n    cells.push(model);\n\n    function updateCell(cell, element, value) {\n      cell.value = value;\n      element.val(cell.value);\n      localStorage[cell.id] = cell.formula;\n      cell.pusher();\n    }\n\n    socketUpdate.filter(function (data) {\n      return data.element === model.id;\n    }).onValue(function (data) {\n      var cell = spreadSheet.getCellById(data.element);\n      var value = data.formula.toUpperCase();\n      pushers = [];\n      cell.formula = value;\n      if (_.isUndefined(value) || value === '') {\n        updateCell(cell, element, 0);\n      } else {\n        if (value.charAt(0) === \"=\") {\n          value = value.substring(1);\n        }\n        value = window.parser(value);\n        calculate(value).onValue(function (x) {\n          updateCell(cell, element, x);\n        });\n        pushers.forEach(function (cell) {\n          cell.pusher();\n        });\n      }\n    });\n\n    element.asEventStream('focus')\n      .onValue(function (event) {\n        var elementid = event.target.id;\n        var value = localStorage[elementid] || \"\";\n        element.val(value);\n      });\n\n    element.asEventStream('blur')\n      .map(function (event) {\n        var elementid = event.target.id;\n        var formula = event.target.value;\n        localStorage[elementid] = formula;\n\n        return {\n          element: elementid,\n          formula: formula,\n          user_id: userId\n        };\n      }).onValue(function (data) {\n        socket.emit('write', data);\n      });\n\n    function add(a, b) {\n      return a + b;\n    }\n\n    function minus(a, b) {\n      return a - b;\n    }\n\n    function multiply(a, b) {\n      return a * b;\n    }\n\n    function divide(a, b) {\n      if (b === 0) {\n        return 0;\n      }\n      return a / b;\n    }\n\n    function fetchAndCombine(token, combiner) {\n      var right = '';\n      var left = calculate(token.left);\n      if (token.right) {\n        right = calculate(token.right);\n      } else {\n        right = Bacon.constant(0);\n      }\n      return left.combine(right, combiner);\n    }\n\n    function calculate(token) {\n      var left = 0;\n      var right = 0;\n      var value = 0;\n      var cell = 0;\n      console.log('calculate:', token.type);\n      if (token.type === 'number') {\n        value = Bacon.constant(parseFloat(token.token));\n      } else if (token.type === 'cellname') {\n        cell = spreadSheet.getCellById(token.token);\n        value = cell.bus;\n        pushers.push(cell);\n        console.log('got cell:', value);\n      } else if (token.type === 'unary') {\n        right = calculate(token.right);\n        if (token.token === '+') {\n          value = right;\n        } else {\n          left = Bacon.constant(0);\n          value = left.combine(right, minus);\n        }\n      } else if (token.type === \"leftparen\") {\n        left = calculate(token.left);\n        right = token.right;\n        if (right.type === 'rightparen') {\n          value = left;\n        }\n      } else if (token.type === 'operator') {\n\n        switch (token.token) {\n          case '+':\n            value = fetchAndCombine(token, add);\n            break;\n          case '-':\n            value = fetchAndCombine(token, minus);\n            break;\n          case '*':\n            value = fetchAndCombine(token, multiply);\n            break;\n          case '/':\n            value = fetchAndCombine(token, divide);\n            break;\n        }\n      }\n      return value;\n    }\n    /* eslint-disable */\n    function getter() {\n      var value = localStorage[element.attr('id')] || \"\";\n      var total = 0;\n      if (value.charAt(0) === \"=\") {\n        value = window.parser(value.substring(1));\n        total = calculate(value);\n        //DATA\n        return total;\n      } else {\n        return isNaN(parseFloat(value)) ? value : parseFloat(value);\n      }\n    }\n    /* eslint-enable */\n\n  });\n\n  spreadSheet.addCells(cells);\n}\n\nvar userId;\n/* eslint-disable */\nvar socket = io.connect('http://localhost:5000');\n/* eslint-enable */\n\nsocket.on('connect', function (data) {\n  socket.emit('join', 'Hello World from client');\n\n  socket.on('userid', function (data) {\n    userId = data;\n  });\n\n  var socketUpdate = Bacon.fromBinder(function (sink) {\n    socket.on('update', function (data) {\n      sink(data);\n    });\n  });\n\n  var socketMessage = Bacon.fromBinder(function (sink) {\n    socket.on('messages', function (data) {\n      sink(data);\n    });\n  });\n\n  processElements(socketUpdate, socketMessage);\n});\n"],"sourceRoot":"/source/"}